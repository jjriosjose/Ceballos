
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>Mapa Ruta Eduar Ceballos</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
        html, body, #map {{
            height: 100%;
            margin: 0;
            font-family: Arial, sans-serif;
        }}
        .sidebar {{
            position: absolute;
            top: 50px;
            left: 10px;
            width: 280px;
            background: white;
            padding: 10px;
            box-shadow: 2px 2px 6px rgba(0,0,0,0.3);
            z-index: 1000;
            border-radius: 6px;
        }}
        .control-btn {{
            display: block;
            width: 100%;
            margin-top: 5px;
            padding: 8px;
            font-size: 14px;
            border-radius: 4px;
            border: none;
            background-color: #f0f0f0;
        }}
        .top-bar {{
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50px;
            background-color: #007bff;
            color: white;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding: 0 20px;
            z-index: 1100;
        }}
    </style>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
    <div class="top-bar">
        <strong>☰ Filtros</strong>
    </div>
    <div id="map"></div>
    <div class="sidebar">
        <label>Condición:</label>
        <select id="condicion"></select>
        <label>Semana:</label>
        <select id="semana"></select>
        <label>Día de la Semana:</label>
        <select id="dia"></select>
        <label>Gestor:</label>
        <select id="gestor"></select>
        <label>Vendedor:</label>
        <select id="vendedor"></select>
        <label>Buscar Cliente:</label>
        <input type="text" id="buscar" placeholder="Escriba el nombre..." />
        <label>Cliente:</label>
        <select id="cliente"></select>
        <button class="control-btn" onclick="visitar()">Visitar</button>
        <button class="control-btn" onclick="registrar()">Registro</button>
        <button class="control-btn" onclick="nuevoCliente()">Nuevo Cliente</button>
    </div>

    <script>
        const map = L.map('map').setView([18.7357, -70.1627], 8);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {{
            attribution: '&copy; OpenStreetMap contributors'
        }}).addTo(map);

        let clientes = [];
        let markers = [];

        fetch("https://docs.google.com/spreadsheets/d/e/2PACX-1vQ9ERHBiz2QlK1GY_pxQhMtcMfQD_uGG_E_hQHC6WO0JzFspkStVqCmuBe6tXLhHsCM31cpsAz8tsJ5/pub?output=csv")
        .then(res => res.text())
        .then(data => {{
            const lines = data.split('\n').slice(1);
            lines.forEach(line => {{
                const [provincia,DIA,SEMANA,vendedor,gestor,CodEmpresa,RazonSocial,Latitud,Longitud] = line.split(',');
                if (!Latitud || !Longitud) return;

                const lat = parseFloat(Latitud);
                const lon = parseFloat(Longitud);
                const marker = L.marker([lat, lon]).addTo(map);
                marker.bindPopup(`<strong>${RazonSocial}</strong>`);
                markers.push(marker);

                clientes.push({{
                    condicion: "Programado",
                    semana: SEMANA,
                    dia: DIA,
                    vendedor,
                    gestor,
                    CodEmpresa,
                    RazonSocial,
                    Latitud: lat,
                    Longitud: lon
                }});
            }});
            actualizarFiltros();
        }});

        function actualizarFiltros() {{
            const vendedorSel = document.getElementById("vendedor");
            const gestorSel = document.getElementById("gestor");
            const clienteSel = document.getElementById("cliente");
            const semanaSel = document.getElementById("semana");
            const diaSel = document.getElementById("dia");
            const condicionSel = document.getElementById("condicion");

            const unique = (arr) => [...new Set(arr)];

            vendedorSel.innerHTML = unique(clientes.map(c => c.vendedor)).map(v => `<option>${v}</option>`).join("");
            gestorSel.innerHTML = unique(clientes.map(c => c.gestor)).map(v => `<option>${v}</option>`).join("");
            clienteSel.innerHTML = unique(clientes.map(c => c.RazonSocial)).map(v => `<option>${v}</option>`).join("");
            semanaSel.innerHTML = unique(clientes.map(c => `Semana ${c.semana}`)).map(v => `<option>${v}</option>`).join("");
            diaSel.innerHTML = unique(clientes.map(c => v.dia)).map(v => `<option>${v}</option>`).join("");
            condicionSel.innerHTML = `<option>Nuevo</option><option>Programado</option>`;
        }}

        function visitar() {{
            const cliente = document.getElementById("cliente").value;
            const c = clientes.find(x => x.RazonSocial === cliente);
            if (c) {{
                window.open(`https://www.google.com/maps/dir/?api=1&destination=${{c.Latitud}},${{c.Longitud}}`);
            }}
        }}

        function registrar() {{
            const cliente = document.getElementById("cliente").value;
            const c = clientes.find(x => x.RazonSocial === cliente);
            if (c) {{
                const url = `https://docs.google.com/forms/d/e/1FAIpQLSeEki-rHj1e1OgDTM9W_VFJmd9k3YfKNIpRhclVaK6mx-hHvA/viewform?usp=pp_url&entry.985299062=Eduar+Ceballos&entry.366494420=${{c.gestor}}&entry.381054793=Existente&entry.1521955635=${{c.CodEmpresa}}&entry.879964686=${{c.RazonSocial}}&entry.1634734772=${{c.Latitud}}&entry.566218311=${{c.Longitud}}`;
                window.open(url);
            }}
        }}

        function nuevoCliente() {{
            const url = "https://docs.google.com/forms/d/e/1FAIpQLSeEki-rHj1e1OgDTM9W_VFJmd9k3YfKNIpRhclVaK6mx-hHvA/viewform";
            window.open(url);
        }}
    </script>
</body>
</html>


<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Mapa Ruta Eduar Ceballos</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        html, body, #map { height: 100%; margin: 0; padding: 0; }
        #panel {
            position: absolute;
            top: 60px;
            left: 10px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            width: 280px;
            max-height: 90%;
            overflow-y: auto;
        }
        #toggleBtn {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1001;
            background-color: #007BFF;
            color: white;
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        select, input, button {
            width: 100%;
            margin-top: 5px;
            margin-bottom: 5px;
            padding: 5px;
            font-size: 14px;
        }
    </style>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
</head>
<body>
<button id="toggleBtn" onclick="togglePanel()">☰ Filtros</button>
<div id="panel">
    <label>Condición:</label>
    <select id="condicion"></select>
    <label>Semana:</label>
    <select id="semana"></select>
    <label>Día de la Semana:</label>
    <select id="dia"></select>
    <label>Gestor:</label>
    <select id="gestor"></select>
    <label>Vendedor:</label>
    <select id="vendedor"></select>
    <label>Buscar Cliente:</label>
    <input type="text" id="buscador" placeholder="Escriba el nombre...">
    <label>Cliente:</label>
    <select id="cliente"></select>
    <button onclick="abrirRuta()">Visitar</button>
    <button onclick="registrarVisita()">Registro</button>
    <button onclick="nuevoCliente()">Nuevo Cliente</button>
</div>
<div id="map"></div>

<script>
let map = L.map('map').setView([18.7357, -70.1627], 8);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18
}).addTo(map);

let dataCSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ9ERHBiz2QlK1GY_pxQhMtcMfQD_uGG_E_hQHC6WO0JzFspkStVqCmuBe6tXLhHsCM31cpsAz8tsJ5/pub?output=csv";
let allData = [];

let markerLayer = L.layerGroup().addTo(map);

function togglePanel() {
    let panel = document.getElementById("panel");
    panel.style.display = (panel.style.display === "none") ? "block" : "none";
}

function cargarFiltros(data, campo, id) {
    let valores = [...new Set(data.map(d => d[campo]).filter(x => x))];
    let select = document.getElementById(id);
    select.innerHTML = '<option value="">-- Seleccione --</option>';
    valores.forEach(v => {
        let option = document.createElement("option");
        option.value = v;
        option.textContent = v;
        select.appendChild(option);
    });
}

function filtrar() {
    let c = document.getElementById("condicion").value.toLowerCase();
    let s = document.getElementById("semana").value.toLowerCase();
    let d = document.getElementById("dia").value.toLowerCase();
    let g = document.getElementById("gestor").value.toLowerCase();
    let v = document.getElementById("vendedor").value.toLowerCase();
    let buscado = document.getElementById("buscador").value.toLowerCase();

    let filtrados = allData.filter(row =>
        (!c || row.Condicion?.toLowerCase() === c) &&
        (!s || row.SEMANA?.toLowerCase() === s) &&
        (!d || row.DIA?.toLowerCase() === d) &&
        (!g || row.gestor_servicio?.toLowerCase() === g) &&
        (!v || row.vendedor?.toLowerCase() === v) &&
        (!buscado || row.RazonSocial?.toLowerCase().includes(buscado))
    );

    actualizarClientes(filtrados);
    mostrarPines(filtrados);
}

function actualizarClientes(data) {
    let clienteSel = document.getElementById("cliente");
    clienteSel.innerHTML = "";
    data.forEach(d => {
        let o = document.createElement("option");
        o.value = JSON.stringify(d);
        o.textContent = d.RazonSocial;
        clienteSel.appendChild(o);
    });
}

function mostrarPines(data) {
    markerLayer.clearLayers();
    data.forEach(d => {
        if (d.Latitud && d.Longitud) {
            let marker = L.marker([parseFloat(d.Latitud), parseFloat(d.Longitud)])
                .bindPopup(`<strong>${d.RazonSocial}</strong><br>${d['Cod Empresa']}`);
            markerLayer.addLayer(marker);
        }
    });
}

function abrirRuta() {
    let cliente = JSON.parse(document.getElementById("cliente").value || null);
    if (cliente?.Latitud && cliente?.Longitud) {
        window.open(`https://www.google.com/maps/dir/?api=1&destination=${cliente.Latitud},${cliente.Longitud}`, "_blank");
    } else {
        alert("Cliente sin ubicación válida.");
    }
}

function registrarVisita() {
    let cliente = JSON.parse(document.getElementById("cliente").value || null);
    if (cliente) {
        let url = `https://docs.google.com/forms/d/e/1FAIpQLSeEki-rHj1e1OgDTM9W_VFJmd9k3YfKNIpRhclVaK6mx-hHvA/viewform?usp=pp_url` +
                  `&entry.985299062=${cliente.vendedor}` +
                  `&entry.366494420=${cliente.gestor_servicio}` +
                  `&entry.381054793=${cliente.Condicion}` +
                  `&entry.1521955635=${cliente['Cod Empresa']}` +
                  `&entry.879964686=${cliente.RazonSocial}` +
                  `&entry.1634734772=${cliente.Latitud}` +
                  `&entry.566218311=${cliente.Longitud}`;
        window.open(url, "_blank");
    } else {
        alert("Seleccione un cliente primero.");
    }
}

function nuevoCliente() {
    window.open("https://docs.google.com/forms/d/e/1FAIpQLSeEki-rHj1e1OgDTM9W_VFJmd9k3YfKNIpRhclVaK6mx-hHvA/viewform", "_blank");
}

Papa.parse(dataCSV, {
    download: true,
    header: true,
    complete: function(results) {
        allData = results.data.filter(d => d.Latitud && d.Longitud);
        cargarFiltros(allData, "Condicion", "condicion");
        cargarFiltros(allData, "SEMANA", "semana");
        cargarFiltros(allData, "DIA", "dia");
        cargarFiltros(allData, "gestor_servicio", "gestor");
        cargarFiltros(allData, "vendedor", "vendedor");
        actualizarClientes(allData);
        mostrarPines(allData);
    }
});

["condicion","semana","dia","gestor","vendedor","buscador"].forEach(id =>
    document.getElementById(id).addEventListener("input", filtrar)
);
</script>
</body>
</html>

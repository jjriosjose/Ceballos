<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Mapa Ruta Eduar Ceballos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" crossorigin="" />
  <style>
    html, body, #map { height: 100%; margin: 0; padding: 0; font-family: sans-serif; }
    .panel {
      position: absolute; top: 50px; left: 10px; background: white;
      padding: 10px; border-radius: 5px; z-index: 1000; width: 300px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    .filtro-btn {
      position: absolute; top: 10px; left: 10px;
      z-index: 1001; background: #007bff; color: white; border: none;
      padding: 8px 12px; border-radius: 4px; cursor: pointer;
    }
    .hidden { display: none; }
  </style>
</head>
<body>
<button id="toggleFiltros" class="filtro-btn">☰ Filtros</button>
<div id="panel" class="panel hidden">
  <label>Condición:<br /><select id="condicion"><option>-- Seleccione --</option></select></label><br />
  <label>Semana:<br /><select id="semana"><option>-- Seleccione --</option></select></label><br />
  <label>Día de la Semana:<br /><select id="dia"><option>-- Seleccione --</option></select></label><br />
  <label>Gestor:<br /><select id="gestor"><option>-- Seleccione --</option></select></label><br />
  <label>Vendedor:<br /><select id="vendedor"><option>-- Seleccione --</option></select></label><br />
  <label>Buscar Cliente:<br /><input id="busqueda" placeholder="Escriba el nombre..." /></label><br />
  <label>Cliente:<br /><select id="cliente"><option>-- Seleccione --</option></select></label><br />
  <button onclick="visitarCliente()">Visitar</button>
</div>
<div id="map"></div>
<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
<script>
const urlCSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ9ERHBiz2QlK1GY_pxQhMtcMfQD_uGG_E_hQHC6WO0JzFspkStVqCmuBe6tXLhHsCM31cpsAz8tsJ5/pub?output=csv";
const urlFormulario = "https://docs.google.com/forms/d/e/1FAIpQLSeEki-rHj1e1OgDTM9W_VFJmd9k3YfKNIpRhclVaK6mx-hHvA/viewform?usp=pp_url";

let data = [];
let markers = [];

const map = L.map("map").setView([18.5, -69.9], 8);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 19
}).addTo(map);

fetch(urlCSV)
  .then(res => res.text())
  .then(text => {
    const rows = text.trim().split("\n").map(r => r.split(","));
    const headers = rows.shift();
    data = rows.map(r => Object.fromEntries(r.map((v, i) => [headers[i], v])));
    actualizarFiltros();
    mostrarClientes();
  });

function actualizarFiltros() {
  const unico = (arr, campo) => [...new Set(arr.map(r => r[campo]).filter(Boolean))];
  const llenar = (id, campo) => {
    const sel = document.getElementById(id);
    unico(data, campo).forEach(v => {
      const o = document.createElement("option");
      o.value = o.text = v;
      sel.appendChild(o);
    });
  };
  llenar("condicion", "Condicion");
  llenar("semana", "SEMANA");
  llenar("dia", "DIA");
  llenar("gestor", "gestor_servicio");
  llenar("vendedor", "vendedor");
  llenar("cliente", "RazonSocial");
}

function mostrarClientes() {
  markers.forEach(m => map.removeLayer(m));
  markers = [];

  data.forEach(row => {
    const lat = parseFloat(row["Latitud"]);
    const lon = parseFloat(row["Longitud"]);
    if (!lat || !lon) return;

    const m = L.marker([lat, lon])
      .addTo(map)
      .bindPopup(`<b>${row["RazonSocial"]}</b><br>${row["Cod Empresa"]}`);
    markers.push(m);
  });
}

function visitarCliente() {
  const r = data.find(row => row["RazonSocial"] === document.getElementById("cliente").value);
  if (!r) return alert("Selecciona un cliente válido.");

  const params = new URLSearchParams({
    "entry.985299062": r["vendedor"],
    "entry.366494420": r["gestor_servicio"],
    "entry.381054793": "Existente",
    "entry.1521955635": r["Cod Empresa"],
    "entry.879964686": r["RazonSocial"],
    "entry.1634734772": r["Latitud"],
    "entry.566218311": r["Longitud"]
  });
  window.open(`${urlFormulario}&${params.toString()}`, "_blank");
}

document.getElementById("toggleFiltros").onclick = () => {
  const p = document.getElementById("panel");
  p.classList.toggle("hidden");
};
</script>
</body>
</html>
